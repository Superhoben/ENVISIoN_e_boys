SHELL=/bin/bash
FIGS := $(shell find ../technical_documentation/figures -not -path '*/\.*')

all: technical_documentation.pdf 

technical_documentation.pdf: technical_documentation.tex $(FIGS)
	NAME=$$(basename "$<" .tex); \
	latexmk -pdf "$$NAME".tex

technical_documentation.tex: technical_documentation.rst
	@echo "Running rst2latex"
	@NAME=$$(basename "$<" .rst); \
	rst2latex --no-section-numbering --use-latex-toc --use-latex-citations "$<" | \
		sed 's/\\hyperref\[\([^]]\+\)\]{[^}]\+}/\\ref{\1}/g' | \
		sed 's/\\phantomsection//g' | \
		perl -pe 'BEGIN{undef $$/;} s/\\section\{[^a-zA-Z]*Referenser[^}]*\\label\{referenser\}[^}]*\}//smg' | \
		perl -pe 'BEGIN{undef $$/;} s/(\\label\{[^}]*\})\s*\\caption\{(.*?)\}\s*\\end\{figure\}/\n\\caption{\2\1}\n\\end{figure}/smg' | \
                cat <(echo -e '% ******************************************************************************************************************\n' \
                              '% ****** !!!WARNING!!! DO NOT EDIT THIS FILE, IT IS AUTOMATICALLY GENERATED FROM technical_documentation.rst  ******\n' \
                              '% ******************************************************************************************************************\n\n') - > "$$NAME".tex; 

clean:
	rm -f *~ 
	latexmk -c -f technical_documentation.tex
	rm -f technical_documentation.tex
